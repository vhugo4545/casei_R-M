<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Galeria ‚Äî Swipe Fullscreen</title>
  <style>
    :root { --bg:#000; --fg:#fff; --muted:#94a3b8; --primary:#2563eb; }
    *{ box-sizing:border-box }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow:hidden; touch-action:pan-y;
    }
    .viewer{ position:fixed; inset:0; display:grid; place-items:center; background:#000 }
    .stage{ position:relative; width:100%; height:100%; overflow:hidden; }
    .stage img{
      position:absolute; inset:0; margin:auto; max-width:100%; max-height:100%;
      object-fit:contain; user-select:none; -webkit-user-drag:none;
      transition:transform .25s ease, opacity .25s ease;
    }
    .nav{
      position:absolute; top:50%; transform:translateY(-50%);
      width:46px; height:46px; border-radius:999px; display:grid; place-items:center;
      background:rgb(105, 105, 105); color:#504e4e; border:1px solid rgba(255,255,255,.18);
      cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent; z-index:10;
    }
    .nav:hover{ background:rgba(255, 255, 255, 0.733) }
    .nav-left{ left:10px } .nav-right{ right:10px }
    .indicator{
      position:absolute; left:50%; bottom:env(safe-area-inset-bottom,12px); transform:translateX(-50%);
      padding:6px 10px; font-size:13px; border-radius:999px; background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14); z-index:10;
    }
    .grabbing{ cursor:grabbing!important }

    /* ===== Popup base ===== */
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none;
      align-items:center; justify-content:center; z-index:9999; padding:16px;
    }
    .modal{
      width:min(640px,92vw); background:#111; color:#fff; border:1px solid #2c2c2c;
      border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.45); overflow:hidden;
      animation:pop .15s ease-out;
    }
    @keyframes pop{ from{ transform:scale(.96); opacity:0 } to{ transform:scale(1); opacity:1 } }
    .modal header{
      padding:14px 16px; background:#151515; border-bottom:1px solid #262626;
      display:flex; align-items:center; justify-content:space-between; gap:8px
    }
    .modal header h3{ margin:0; font-size:16px }
    .modal .body{ padding:16px; display:grid; gap:12px; line-height:1.55 }
    .muted{ color:var(--muted) }
    .btn{
      appearance:none; border:1px solid #2a2a2a; background:#1a1a1a; color:#fff; padding:10px 12px;
      border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn.primary{ background:var(--primary); border-color:var(--primary) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    /* PIX modal specifics */
    .email{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      background:#0f172a; padding:10px 12px; border-radius:10px; border:1px solid #1f2937;
      display:flex; align-items:center; justify-content:space-between; gap:8px; word-break:break-all;
    }
    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px; background:#16a34a; color:#fff; display:none;
    }
    .footer{ display:flex; gap:8px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #262626; background:#141414 }

    /* Guestbook modal */
    .list{
      display:grid; gap:10px; max-height:45vh; overflow:auto; padding-right:4px;
      border:1px solid #222; border-radius:12px; padding:12px;
      background:#0f0f0f;
    }
    .msg{
      background:#0e1013; border:1px solid #23262d; border-radius:12px; padding:10px 12px;
    }
    .msg .who{ font-weight:700 }
    .msg .when{ font-size:12px; color:var(--muted) }
    .row{ display:grid; gap:10px }
    .row.grid-2{ grid-template-columns: 1fr 1fr }
    .input, .textarea{
      width:100%; padding:10px 12px; border-radius:10px; background:#0d0d0d; color:#fff;
      border:1px solid #2a2a2a; font:inherit;
    }
    .textarea{ min-height:90px; resize:vertical }

    /* ===== Iframe (link 04) + X + loading ===== */
    .modal-iframe{ width:min(900px,94vw); height:min(600px,90vh); display:flex; flex-direction:column; }
    .modal-iframe iframe{ flex:1; width:100%; border:0; border-top:1px solid #222; background:#0b0b0b; }
    .btn-icon{ display:grid; place-items:center; width:36px; height:36px; border-radius:10px; font-size:18px; line-height:1; padding:0;
      appearance:none; border:1px solid #2a2a2a; background:#1a1a1a; color:#fff; cursor:pointer; font-weight:600; }
    .loading{ display:flex; align-items:center; gap:8px; padding:8px 12px; font-size:13px; color:#cbd5e1 }
    .hidden{ display:none !important; }


    
  </style>
</head>
<body>
  <div class="viewer" id="app">
    <div class="stage" id="stage">
      <img id="photo" alt="foto" draggable="false" />
      <div class="nav nav-left"  id="prevBtn" aria-label="Anterior">‚Äπ</div>
      <div class="nav nav-right" id="nextBtn" aria-label="Pr√≥xima">‚Ä∫</div>
      <div class="indicator" id="indicator">1 / 1</div>
    </div>
  </div>

  <!-- Popup PIX -->
  <div class="backdrop" id="pixBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pixTitle">
      <header>
        <h3 id="pixTitle">PIX copiado</h3>
        <button class="btn" id="pixClose">Fechar</button>
      </header>
      <div class="body">
        <div>
          Sua presen√ßa j√° √© um presente <br>
          Mas se quiser participar da lua de mel ‚Ä¶ pix √© o e-mail!
        </div>
        <div class="email">
          <span id="pixText">luademelcasalMR@gmail.com</span>
          <span class="badge" id="pixBadge">Copiado!</span>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="pixCopy">Copiar novamente</button>
        <button class="btn primary" id="pixOk">Ok</button>
      </div>
    </div>
  </div>

  <!-- Popup Guestbook (mensagens) -->
  <div class="backdrop" id="gbBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="gbTitle">
      <header>
        <h3 id="gbTitle">Deixe uma mensagem para os noivos üíå</h3>
        <button class="btn" id="gbClose">Fechar</button>
      </header>
      <div class="body">
        <div class="muted">Veja o carinho que a galera j√° deixou e escreva o seu tamb√©m!</div>

        <div class="list" id="gbList">
          <!-- mensagens renderizadas aqui -->
        </div>

        <div class="row">
          <input class="input" id="gbNome" placeholder="Seu nome" />
          <textarea class="textarea" id="gbMsg" placeholder="Sua mensagem aos noivos"></textarea>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="gbRefresh">Atualizar</button>
        <button class="btn primary" id="gbSend">Enviar mensagem</button>
      </div>
    </div>
  </div>

  <!-- Popup do LINK_04 (iframe) -->
  <div class="backdrop" id="iframeBackdrop" aria-hidden="true">
    <div class="modal modal-iframe" role="dialog" aria-modal="true" aria-labelledby="iframeTitle">
      <header>
        <h3 id="iframeTitle">Visualiza√ß√£o</h3>
        <div style="display:flex; gap:8px; align-items:center">
          <a class="btn" id="iframeOpen" href="#" target="_blank" rel="noopener">Abrir em nova aba</a>
          <button class="btn-icon" id="iframeX" aria-label="Fechar">√ó</button>
        </div>
      </header>
      <div id="iframeLoading" class="loading">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="10" stroke="#94a3b8" stroke-width="3" opacity=".25"/>
          <path d="M22 12a10 10 0 0 1-10 10" stroke="#94a3b8" stroke-width="3">
            <animateTransform attributeName="transform" type="rotate" dur="0.9s" repeatCount="indefinite" from="0 12 12" to="360 12 12"/>
          </path>
        </svg>
        Carregando‚Ä¶
      </div>
      <iframe id="iframeView" src="" title="Conte√∫do"></iframe>
      <div id="iframeBlocked" class="body hidden">
        <div class="muted">
          O site n√£o permite ser exibido dentro de um iframe. Use o bot√£o <b>Abrir em nova aba</b> acima.
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Configs ===== */
    const IMAGES   = ["01.PNG","02.PNG","03.PNG","04.PNG","05.PNG","06.PNG","07.PNG"];
    const LINK_04  = "https://app.kululu.com/xsfjee";
    const PIX_EMAIL = "luademelcasalMR@gmail.com";

    // SheetDB endpoint
    const SHEETDB_URL = "https://sheetdb.io/api/v1/2smd4m5xnc8c5";

    const img = document.getElementById('photo');
    const indicator = document.getElementById('indicator');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const stage = document.getElementById('stage');

    let index = 0;

    function preload(i){
      [i-1,i+1].forEach(k=>{
        const j=(k+IMAGES.length)%IMAGES.length;
        const a=new Image(); a.src=IMAGES[j];
      });
    }
    function show(i, dir=0){
      index=(i+IMAGES.length)%IMAGES.length;
      indicator.textContent=(index+1)+" / "+IMAGES.length;
      img.style.opacity=0; img.style.transform=`translateX(${dir*-20}px)`;
      requestAnimationFrame(()=>{
        img.src=IMAGES[index];
        img.onload=()=>{ img.style.opacity=1; img.style.transform='translateX(0)' }
      });
      preload(index);
    }
    function next(){ show(index+1,+1) }
    function prev(){ show(index-1,-1) }
    prevBtn.addEventListener('click',prev);
    nextBtn.addEventListener('click',next);
    window.addEventListener('keydown',e=>{
      if(e.key==='ArrowRight') next();
      if(e.key==='ArrowLeft')  prev();
    });

    // ===== Clipboard helpers =====
    function copyFallback(text){
      return new Promise((resolve,reject)=>{
        const ta=document.createElement('textarea');
        ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.focus(); ta.select();
        try{
          const ok=document.execCommand && document.execCommand('copy');
          document.body.removeChild(ta);
          ok?resolve():reject(new Error('execCommand falhou'));
        }catch(err){ document.body.removeChild(ta); reject(err) }
      });
    }
    function copyText(text){
      if(navigator.clipboard?.writeText) return navigator.clipboard.writeText(text);
      return copyFallback(text);
    }

    // ===== PIX modal =====
    const pixBackdrop = document.getElementById('pixBackdrop');
    const pixText = document.getElementById('pixText');
    const pixBadge = document.getElementById('pixBadge');
    const pixClose = document.getElementById('pixClose');
    const pixOk = document.getElementById('pixOk');
    const pixCopy = document.getElementById('pixCopy');

    function openPixPopup(){
      pixText.textContent = PIX_EMAIL;
      pixBadge.style.display = 'none';
      pixBackdrop.style.display = 'flex';
      pixBackdrop.setAttribute('aria-hidden','false');
      copyText(PIX_EMAIL).then(()=>{ pixBadge.style.display='inline-block'; }).catch(()=>{});
    }
    function closePixPopup(){
      pixBackdrop.style.display = 'none';
      pixBackdrop.setAttribute('aria-hidden','true');
    }
    pixCopy.addEventListener('click', async ()=>{
      try{ await copyText(PIX_EMAIL); pixBadge.style.display='inline-block'; }
      catch(e){ alert('N√£o foi poss√≠vel copiar automaticamente. Copie manualmente: '+PIX_EMAIL) }
    });
    pixOk.addEventListener('click', closePixPopup);
    pixClose.addEventListener('click', closePixPopup);
    pixBackdrop.addEventListener('click', e=>{ if(e.target===pixBackdrop) closePixPopup(); });

    // ===== Guestbook modal (SheetDB) =====
    const gbBackdrop = document.getElementById('gbBackdrop');
    const gbClose = document.getElementById('gbClose');
    const gbList = document.getElementById('gbList');
    const gbNome = document.getElementById('gbNome');
    const gbMsg  = document.getElementById('gbMsg');
    const gbSend = document.getElementById('gbSend');
    const gbRefresh = document.getElementById('gbRefresh');

    function openGuestbook(){
      gbBackdrop.style.display = 'flex';
      gbBackdrop.setAttribute('aria-hidden','false');
      loadMessages();
    }
    function closeGuestbook(){
      gbBackdrop.style.display = 'none';
      gbBackdrop.setAttribute('aria-hidden','true');
    }
    gbClose.addEventListener('click', closeGuestbook);
    gbBackdrop.addEventListener('click', (e)=>{ if(e.target===gbBackdrop) closeGuestbook(); });
    gbRefresh.addEventListener('click', loadMessages);

    function fmtDate(d){
      try{
        const date = new Date(d);
        if (!isNaN(date)) return date.toLocaleString('pt-BR');
      }catch(_){}
      return d || '';
    }

    async function loadMessages(){
      gbList.innerHTML = `<div class="muted">Carregando mensagens‚Ä¶</div>`;
      try{
        const resp = await fetch(SHEETDB_URL, { cache: "no-store" });
        const arr = await resp.json();
        const data = Array.isArray(arr) ? arr : [];
        data.sort((a,b)=> String(b.createdAt||'').localeCompare(String(a.createdAt||'')));

        if (!data.length){
          gbList.innerHTML = `<div class="muted">Ainda n√£o h√° mensagens. Seja o primeiro(a) a deixar um carinho! ü•∞</div>`;
          return;
        }

        gbList.innerHTML = "";
        data.forEach(row=>{
          const div = document.createElement('div');
          div.className = 'msg';
          div.innerHTML = `
            <div class="who">${(row.nome||'An√¥nimo')}</div>
            <div class="text">${(row.mensagem||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
            <div class="when">${fmtDate(row.createdAt)}</div>
          `;
          gbList.appendChild(div);
        });
      }catch(err){
        gbList.innerHTML = `<div class="muted">Falha ao carregar mensagens.</div>`;
        console.error(err);
      }
    }

    async function sendMessage(){
      const nome = (gbNome.value||'').trim();
      const mensagem = (gbMsg.value||'').trim();
      if (!nome || !mensagem){
        alert('Preencha nome e mensagem.');
        return;
      }
      const payload = {
        data: [{
          createdAt: new Date().toISOString(),
          nome,
          mensagem
        }]
      };
      gbSend.disabled = true;
      gbSend.textContent = "Enviando‚Ä¶";
      try{
        const resp = await fetch(SHEETDB_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        await resp.json();
        gbNome.value = ""; gbMsg.value = "";
        await loadMessages();
        gbSend.textContent = "Mensagem enviada!";
        setTimeout(()=>{ gbSend.textContent = "Enviar mensagem"; gbSend.disabled = false; }, 900);
      }catch(err){
        console.error(err);
        alert("Falha ao enviar. Tente novamente.");
        gbSend.disabled = false;
        gbSend.textContent = "Enviar mensagem";
      }
    }
    gbSend.addEventListener('click', sendMessage);

    // ===== Iframe Popup (LINK_04) =====
    const iframeBackdrop = document.getElementById('iframeBackdrop');
    const iframeView = document.getElementById('iframeView');
    const iframeX = document.getElementById('iframeX');
    const iframeOpen = document.getElementById('iframeOpen');
    const iframeLoading = document.getElementById('iframeLoading');
    const iframeBlocked = document.getElementById('iframeBlocked');

    function openIframePopup(url){
      iframeOpen.href = url;                   // fallback "Abrir em nova aba"
      iframeLoading.classList.remove('hidden');
      iframeBlocked.classList.add('hidden');

      let loaded = false;
      const onLoad = () => {
        loaded = true;
        iframeLoading.classList.add('hidden');
        // Se carrega, mantemos o iframe vis√≠vel normalmente
      };
      // limpar handlers anteriores
      iframeView.onload = null;
      iframeView.onerror = null;

      iframeView.onload = onLoad;
      iframeView.onerror = () => {
        // Alguns navegadores n√£o disparam onerror para bloqueio por X-Frame-Options.
        // O timeout abaixo cobre esse caso.
      };

      // Timeout: se n√£o carregar em X ms, assume bloqueio e mostra fallback
      iframeView.src = url;
      setTimeout(() => {
        if (!loaded) {
          iframeLoading.classList.add('hidden');
          iframeBlocked.classList.remove('hidden');
        }
      }, 3500);

      iframeBackdrop.style.display = 'flex';
      iframeBackdrop.setAttribute('aria-hidden','false');
    }
    function closeIframePopup(){
      iframeView.src = '';
      iframeBackdrop.style.display = 'none';
      iframeBackdrop.setAttribute('aria-hidden','true');
    }
    iframeX.addEventListener('click', closeIframePopup);
    iframeBackdrop.addEventListener('click', (e)=>{ if(e.target===iframeBackdrop) closeIframePopup(); });

    // Clique na imagem: a√ß√µes espec√≠ficas
    img.addEventListener('click', () => {
      const name = IMAGES[index];
      if (name === "04.PNG") { openIframePopup(LINK_04); return; }
      if (name === "06.PNG") { openPixPopup(); return; }
      if (name === "07.PNG")  { window.open(LINK_04, "_blank"); return; }
    });

    // ===== Swipe =====
    let startX=0,startY=0,tracking=false,moved=false;
    stage.addEventListener('pointerdown',e=>{
      tracking=true; moved=false; startX=e.clientX; startY=e.clientY;
      stage.setPointerCapture(e.pointerId); document.body.classList.add('grabbing');
    });
    stage.addEventListener('pointermove',e=>{
      if(!tracking) return;
      const dx=e.clientX-startX, dy=e.clientY-startY;
      if(Math.abs(dx)>Math.abs(dy)){ moved=true; img.style.transform=`translateX(${dx*.6}px)`; img.style.opacity=String(1-Math.min(Math.abs(dx)/300,.4)) }
    });
    stage.addEventListener('pointerup',e=>{
      if(!tracking) return; tracking=false; document.body.classList.remove('grabbing');
      const dx=e.clientX-startX, TH=60;
      if(moved && Math.abs(dx)>TH){ dx<0?next():prev() } else { img.style.transform='translateX(0)'; img.style.opacity=1 }
    });
    stage.addEventListener('pointercancel',()=>{ tracking=false; document.body.classList.remove('grabbing'); img.style.transform='translateX(0)'; img.style.opacity=1 });

    // Start
    show(0);
  </script>
</body>
</html>
